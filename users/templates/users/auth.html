<!-- templates/users/auth.html -->
{% extends 'base.html' %} {% block title %}ورود / ثبت نام{% endblock %} {% block
content %}
<div class="auth-container">
  <div class="card">
    <div class="card-header text-center">
      <h4>🏥 داروخانه آنلاین</h4>
      <p class="text-muted">ورود یا ثبت نام با شماره موبایل</p>
    </div>
    <div class="card-body">
      {% if not show_otp_form %}
      <!-- Phone Number Form -->
      <form method="post" id="phone-form">
        {% csrf_token %}
        <div class="mb-3">
          <label
            for="{{ phone_form.phone_number.id_for_label }}"
            class="form-label"
          >
            شماره موبایل
          </label>
          {{ phone_form.phone_number }} {% if phone_form.phone_number.errors %}
          <div class="text-danger small">
            {{ phone_form.phone_number.errors.0 }}
          </div>
          {% endif %}
        </div>
        <button type="submit" name="send_otp" class="btn btn-primary w-100">
          ارسال کد تایید
        </button>
      </form>
      {% else %}
      <!-- OTP Verification Form -->
      <form method="post" id="otp-form">
        {% csrf_token %} {{ otp_form.phone_number }}

        <div class="text-center mb-3">
          <p>
            کد تایید به شماره
            <strong>{{ otp_form.phone_number.value }}</strong> ارسال شد
          </p>
        </div>

        <div class="mb-3">
          <label
            for="{{ otp_form.otp_code.id_for_label }}"
            class="form-label text-center w-100"
          >
            کد تایید ۶ رقمی
          </label>
          {{ otp_form.otp_code }} {% if otp_form.otp_code.errors %}
          <div class="text-danger small text-center">
            {{ otp_form.otp_code.errors.0 }}
          </div>
          {% endif %}
        </div>

        <button
          type="submit"
          name="verify_otp"
          class="btn btn-success w-100 mb-2"
        >
          تایید و ورود
        </button>

        <div class="text-center">
          <button type="button" class="btn-resend" onclick="resendOTP()">
            ارسال مجدد کد
          </button>
          <span id="countdown" class="text-muted"></span>
        </div>
      </form>

      <div class="text-center mt-3">
        <a href="{% url 'auth' %}" class="btn btn-outline-secondary btn-sm">
          تغییر شماره موبایل
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {% if show_otp_form %}
<script>
  let countdown = 60;
  const countdownElement = document.getElementById("countdown");
  const resendButton = document.querySelector(".btn-resend");

  function updateCountdown() {
    if (countdown > 0) {
      countdownElement.textContent = `(${countdown} ثانیه)`;
      resendButton.disabled = true;
      countdown--;
      setTimeout(updateCountdown, 1000);
    } else {
      countdownElement.textContent = "";
      resendButton.disabled = false;
    }
  }

  function resendOTP() {
    fetch('{% url "resend_otp" %}', {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
        "Content-Type": "application/x-www-form-urlencoded",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          countdown = 60;
          updateCountdown();
          alert("کد تایید مجدداً ارسال شد");
        } else {
          alert("خطا در ارسال کد: " + data.message);
        }
      });
  }

  // Start countdown on page load
  updateCountdown();

  // Auto-focus on OTP input
  document.getElementById("{{ otp_form.otp_code.id_for_label }}").focus();
</script>
{% endif %} {% endblock %}
