<!-- templates/users/auth.html -->
{% extends 'base.html' %} {% block title %}ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øª Ù†Ø§Ù…{% endblock %} {% block
content %}
<div class="auth-container">
  <div class="card">
    <div class="card-header text-center">
      <h4>ğŸ¥ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</h4>
      <p class="text-muted">ÙˆØ±ÙˆØ¯ ÛŒØ§ Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</p>
    </div>
    <div class="card-body">
      {% if not show_otp_form %}
      <!-- Phone Number Form -->
      <form method="post" id="phone-form">
        {% csrf_token %}
        <div class="mb-3">
          <label
            for="{{ phone_form.phone_number.id_for_label }}"
            class="form-label"
          >
            Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„
          </label>
          {{ phone_form.phone_number }} {% if phone_form.phone_number.errors %}
          <div class="text-danger small">
            {{ phone_form.phone_number.errors.0 }}
          </div>
          {% endif %}
        </div>
        <button type="submit" name="send_otp" class="btn btn-primary w-100">
          Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯
        </button>
      </form>
      {% else %}
      <!-- OTP Verification Form -->
      <form method="post" id="otp-form">
        {% csrf_token %} {{ otp_form.phone_number }}

        <div class="text-center mb-3">
          <p>
            Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡
            <strong>{{ otp_form.phone_number.value }}</strong> Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯
          </p>
        </div>

        <div class="mb-3">
          <label
            for="{{ otp_form.otp_code.id_for_label }}"
            class="form-label text-center w-100"
          >
            Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Û¶ Ø±Ù‚Ù…ÛŒ
          </label>
          {{ otp_form.otp_code }} {% if otp_form.otp_code.errors %}
          <div class="text-danger small text-center">
            {{ otp_form.otp_code.errors.0 }}
          </div>
          {% endif %}
        </div>

        <button
          type="submit"
          name="verify_otp"
          class="btn btn-success w-100 mb-2"
        >
          ØªØ§ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯
        </button>

        <div class="text-center">
          <button type="button" class="btn-resend" onclick="resendOTP()">
            Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ú©Ø¯
          </button>
          <span id="countdown" class="text-muted"></span>
        </div>
      </form>

      <div class="text-center mt-3">
        <a href="{% url 'auth' %}" class="btn btn-outline-secondary btn-sm">
          ØªØºÛŒÛŒØ± Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {% if show_otp_form %}
<script>
  let countdown = 60;
  const countdownElement = document.getElementById("countdown");
  const resendButton = document.querySelector(".btn-resend");

  function updateCountdown() {
    if (countdown > 0) {
      countdownElement.textContent = `(${countdown} Ø«Ø§Ù†ÛŒÙ‡)`;
      resendButton.disabled = true;
      countdown--;
      setTimeout(updateCountdown, 1000);
    } else {
      countdownElement.textContent = "";
      resendButton.disabled = false;
    }
  }

  function resendOTP() {
    fetch('{% url "resend_otp" %}', {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
        "Content-Type": "application/x-www-form-urlencoded",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          countdown = 60;
          updateCountdown();
          alert("Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯");
        } else {
          alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯: " + data.message);
        }
      });
  }

  // Start countdown on page load
  updateCountdown();

  // Auto-focus on OTP input
  document.getElementById("{{ otp_form.otp_code.id_for_label }}").focus();
</script>
{% endif %} {% endblock %}
